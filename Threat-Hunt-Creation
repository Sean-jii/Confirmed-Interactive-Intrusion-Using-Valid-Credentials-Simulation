Confirmed Interactive Intrusion Using Valid Credentials Simulation


Platform: Azure Windows 10 Virtual Machines
Security Tooling: Microsoft Defender for Endpoint
Hunting Method: KQL (Advanced Hunting)


Summary:

This project simulates a realistic post‑compromise attack against a Windows 10 system hosted in Azure. The goal is to demonstrate how an attacker can move from valid credential access to persistence and data staging without deploying custom malware, relying instead on built‑in Windows tools.
The threat hunt is intentionally designed to look like normal administrative or user activity at first glance. Each action produces telemetry that, when correlated, clearly tells the story of an intrusion. This mirrors how real SOC teams hunt for threats using behavioral patterns rather than signatures.
Ten distinct “flags” are generated, each representing a meaningful attacker action that can be detected and hunted using Microsoft Defender for Endpoint.

Lab Contains: 

- Azure Windows 10 VM exposed via RDP
- Microsoft Defender for Endpoint onboarded
- Three local accounts:
  - AdminUser – legitimate administrator
  - jsmith – standard user (compromised account)
  - vc-backup – attacker‑created persistence account




Part 1 — Create the Victim User Context

A standard user account is created on the Windows 10 virtual machine to represent a legitimate but compromised user. This account is intentionally non-administrative and is granted Remote Desktop access to simulate a realistic credential abuse scenario commonly observed in enterprise environments. The following commands are executed on the system to create the user and allow RDP access:

net user jsmith P@ssw0rd123! /add
net localgroup "Remote Desktop Users" jsmith /add


This user account represents the attacker’s initial foothold after obtaining valid credentials.



Part 2 — Attack Simulation (Flag-by-Flag)

The attack simulation is conducted entirely using native Windows utilities. Each action represents a meaningful attacker behavior and produces telemetry that can later be identified through threat hunting. When viewed individually, the actions resemble normal user or administrative activity, but when correlated they clearly indicate malicious intent.



Flag 1 and Flag 2 — Suspicious Logon Activity

Suspicious logon activity is generated by remotely connecting to the virtual machine using RDP from a different external network such as a mobile hotspot, VPN, or separate virtual machine. The connection is intentionally performed during late-night or early-morning hours to ensure the authentication occurs outside of normal business hours. This produces DeviceLogonEvents telemetry that includes a rare RemoteIP value combined with an anomalous timestamp, triggering both flags.



Flag 3 — PowerShell Execution by a Non-Administrative User

While logged in as the standard user jsmith, PowerShell is launched interactively. This demonstrates post-compromise execution capability using a living-off-the-land binary that is commonly abused by attackers. The following command is used:

powershell.exe


This activity is recorded in DeviceProcessEvents and establishes baseline post-logon execution behavior.



Flag 4 — Encoded PowerShell Execution

Command obfuscation is simulated by executing an encoded PowerShell command. While logged in as jsmith, the following commands are used to encode and execute a simple instruction:

$cmd = "whoami"
$bytes = [System.Text.Encoding]::Unicode.GetBytes($cmd)
$encoded = [Convert]::ToBase64String($bytes)
powershell -EncodedCommand $encoded


This behavior produces telemetry consistent with obfuscated execution, which is a strong indicator of adversary tradecraft.



Flag 5 — System and Account Discovery

Discovery activity is performed to simulate an attacker gathering situational awareness about the compromised system. Standard system, network, and account enumeration commands are executed:

whoami
ipconfig /all
systeminfo
net user
net localgroup administrators


These commands generate telemetry related to system information discovery, network discovery, and account enumeration.



Flag 6 — Credential Access Attempt (Simulated Safely)

Rather than performing unsafe credential dumping, intent is simulated by accessing protected processes and registry locations. This safely generates detection signals without extracting credentials. One of the following commands is executed:

tasklist | findstr lsass


or

reg query HKLM\SAM


These actions indicate attempted credential access and are logged by Defender.



Flag 7 — Account Manipulation and Persistence

Persistence is established by creating a new local account and granting it administrative privileges. This step is performed while logged in as an administrative user rather than the compromised standard account. The following commands are used:

net user svc-backup P@ssw0rd! /add
net localgroup administrators svc-backup /add


This activity demonstrates account manipulation and long-term access establishment.



Flag 8 — Scheduled Task Persistence

A scheduled task is created to execute a hidden PowerShell command under the SYSTEM account. This represents a common persistence mechanism used to maintain access across system reboots. The following command is executed:

schtasks /create `
 /sc daily `
 /st 09:00 `
 /tn "UpdaterService" `
 /tr "powershell.exe -WindowStyle Hidden -Command whoami" `
 /ru SYSTEM


This action generates telemetry related to scheduled task creation and privileged execution.



Flag 9 — Suspicious Outbound Network Activity

Outbound network communication is generated to simulate command-and-control or staging behavior. This is accomplished using a simple web request or ICMP traffic. One of the following commands is executed:

Invoke-WebRequest http://example.com


or

ping 8.8.8.8


These actions result in DeviceNetworkEvents showing connections to public external endpoints.



Flag 10 — Local Data Staging via Compression

Local data staging is simulated by compressing a file into an archive stored in a publicly accessible directory. This represents preparation for data exfiltration. The following command is executed:

Compress-Archive `
 -Path C:\Windows\System32\drivers\etc\hosts `
 -DestinationPath C:\Users\Public\data.zip


This action generates file creation telemetry consistent with archive-based data staging.
